---
title: "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin (NW Iberian Peninsula)"
author: "Mikel Diaz-Rodriguez and Ramon Fabregas-Valcarce"
date: "March 9th, 2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE,
                      echo = TRUE)
```

# Introduction

This document contains code to enable reproducibility of the paper "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin (NW Iberian Peninsula)".

The steps indicated in the following lines allow to reproduce the analyses carried out.

# Packages used
### Import the packages

```{r echo=TRUE, results='hide'}
# ipak function: install and load multiple R packages.

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
# install all the packages
packages <- c("GGally", "spatstat", "dismo", "MASS", "ggplot2", "plyr", "sp", "maps", "maptools", "raster", "geostatsp", "rgdal")
ipak(packages)
```


# Complete Spatial Randomness
### Import the data used in CSR analysis

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# set the projection 
BNG = "+init=epsg:25829"

# add the study area 
studyarea <- readShapePoly("study_area.shp", proj4string = CRS(BNG))

# and check it is worked
plot(studyarea)

# add the sites
sites <- readShapePoints("sites.shp", proj4string = CRS(BNG))

# add the random points
random_sites <- readShapePoints("random_sites.shp", proj4string = CRS(BNG))

# plot the studyarea and the sites and check everything looks ok
plot(sites, col="blue", pch=20, add=T)

# remove any sites with the same grid reference
sites <- remove.duplicates(sites)

# select the points inside the studyarea 
sitesSub <- sites[studyarea,]

# check to see that they have been removed
plot(studyarea)
plot(sitesSub, col="red", pch=20, add=T)

# set a window as the studyarea
window <- as.owin(studyarea)
plot(window)

# create a ppp object
sitesSub.ppp <- ppp(x=sitesSub$UTMX,y=sitesSub$UTMY,window=window)

# plot the sites and the studyarea
plot(sitesSub.ppp,pch=16,cex=0.5, main="Palaeolithic archaeological sites")
```

### Shapiro-Wilk Test

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# Shapiro-Wilk Test
shapiro.test(sites$UTMX)
```

### K-S Test

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# K-S sites vs random sites
ks.test(sites$UTMX,random_sites$UTMX)
```

### X2 Test

```{r echo=TRUE, results='hide'}
# X2 test sites
chisq.test(sites$UTMX,sites$UTMX)
```

### K, L and G Functions

```{r echo=TRUE, results='hide'}
# set the simulations
sims <- 99
# to get 95% envelope
nrank <- round((sims + 1) / 100 * 2.5, 0) 

# Kfunction sites
Kfunction <- envelope(sitesSub.ppp,Kest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(Kfunction,main="a. K Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4a.pdf",width = 5,height = 12)
# Inhomogeneous
KinhomFunction <- envelope(sitesSub.ppp,Kinhom, nsim=sims,rank=nrank, correction="best") 
plot(KinhomFunction,main="b. K Function (inhomogeneous)",legend=FALSE)
pdf(file = "~output/Figure4b.pdf",width = 5,height = 12)

# LFunction sites
LFunction <- envelope(sitesSub.ppp,Lest, nsim=sims,rank=nrank, correction="best")
# Homogeneous
plot(LFunction,main="c. L Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4c.pdf",width = 5,height = 12)
# Inhomogeneous
LinhomFunction <- envelope(sitesSub.ppp,Linhom, nsim=sims,rank=nrank, correction="best")
plot(LinhomFunction,main="d. L Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4d.pdf",width = 5,height = 12)

# GFunction sites
GFunction <- envelope(sitesSub.ppp,Gest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(GFunction,main="e. G Function (homogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4e.pdf",width = 5,height = 12)
# Inhomogeneous
GinhomFunction <- envelope(sitesSub.ppp,Ginhom, nsim=sims,rank=nrank, correction="best") 
plot(GinhomFunction,main="f. G Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4f.pdf",width = 5,height = 12)
```

# Pearson's Correlation

```{r echo=TRUE, results='hide'}
# Set the working directory
setwd("~/xls")

# Data
sample_data <- data.frame(v1=dat$altitude,v2=dat$wetland_cost,v3=dat$goat_cost,v5=dat$geology_cost,v6=dat$hydrology_cost,v7=dat$lcp_cost,v8=dat$eucl_dist_geo,v9=dat$eucl_dist_hydro,v10=dat$dif_ins,v11=dat$dir_ins,v12=dat$tot_ins,v13=dat$aspect,v14=dat$slope,v15=dat$vis_prom,v16=dat$tpi100,v17=dat$tpi500,v18=dat$tpi1000,v19=dat$wind)

# Check correlations
cor(sample_data)

# Check correlations as scatterplots, distributions and correlation coeficient.
ggpairs(sample_data)

# Visualization
ggcorr(sample_data, method=c("everything", "pearson"))

# Export file
pdf(file = "~output/Figure2a.pdf",width = 5,height = 12)
```

# GLM

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# ad the shapefile
locations <- readOGR(dsn="locations.shp", layer="locations")

# set the working directory
setwd("~/grids")

# Import variables and set the same extent for everyone
elevation <- raster("dem_monforte.tif")
tot_ins <- raster("total_insolation_monforte.asc")
tot_inso <- projectRaster(tot_ins, elevation)
asp <- raster("aspect_monforte.tif")
aspect <- projectRaster(asp, elevation)
slop <- raster("slope_monforte.tif")
slope <- projectRaster(slop, elevation)
vis_prom <- raster("visual_prominence_monforte.tif")
visual_prom <- projectRaster(vis_prom, elevation)
tpi100_monf <- raster("tpi100_monforte.asc")
tpi100 <- projectRaster(tpi100_monf, elevation)

tpi500_monf <- raster("tpi500_monforte.asc")
tpi500 <- projectRaster(tpi500_monf, elevation)

wind_monf <- raster("wind_monforte.asc")
wind <- projectRaster(wind_monf, elevation)
wetland_c <- raster("wetland_cost_monforte.tiff")
wetland_cost <- projectRaster(wetland_c, elevation)
goat_c <- raster("goat_cost_monforte.tiff")
goat_cost <- projectRaster(goat_c, elevation)
geol_c <- raster("geology_cost_monforte.tiff")
geol_cost <- projectRaster(geol_c, elevation)
hydro_c <- raster("hydrology_cost_monforte.tiff")
hydro_cost <- projectRaster(hydro_c, elevation)
lcp_c <- raster("lcp_cost_monforte.tiff")
lcp_cost <- projectRaster(lcp_c, elevation)

dist_eucl_geo <- raster("distancia_euclidiana_geologia_monforte2.tif")
dist_eucl_geologia <- projectRaster(dist_eucl_geo, elevation)
dist_eucl_hidro <- raster("distancia_euclidiana_hidrologia_monforte2.tif")
dist_eucl_hidrologia <- projectRaster(dist_eucl_hidro, elevation)
```

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# GLM creation
covariates <- stack(elevation, tot_inso, aspect, slope, visual_prom, tpi100, wetland_cost, geol_cost, hydro_cost, lcp_cost, wind, tpi500)
names(covariates) <- c("elevation", "tot_inso", "aspect", "slope", "visual_prom", "tpi100", "wetland_cost", "geol_cost","hydro_cost", "lcp_cost", "wind", "tpi500")
locvals <- data.frame(extract(covariates, locations))
locvals$site <- locations$CID==1

mod <- glm(site~elevation+tot_inso+aspect+slope+visual_prom+tpi100+wetland_cost+geol_cost+hydro_cost+lcp_cost+wind+tpi500, data=locvals, family=binomial(logit))
summary(mod)
mod2 <- stepAIC(mod)  # More oncs
mod2$anova

# Table with the results of predictive analysis
summary(mod2) 
logodds <- 7.2294176+(elevation* -0.0167014)+(slope*-0.3456405)+(visual_prom*0.0458370)+(wetland_cost*-0.0017355)+(hydro_cost*0.0007585)
par(mfrow=c(1,1))
plot(logodds)

# Predictive map creation
relprob <- (exp(logodds))/(1+(exp(logodds)))
par(mfrow=c(1,1))
plot(relprob, col=terrain.colors(8, alpha=1), legend=TRUE, axes=TRUE, main="GLM Monforte")
points(locations[locations$CID==1,], pch=19, cex=0.3, col="red")

# Output predictive surface .asc 
writeRaster(relprob,filename = "predicsurface2.asc", datatype="ascii", overwrite=TRUE)
```

# Intensity analysis
### Data import

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
elevation <- raster("grids/dem_monforte.tif")
studyarea <- readOGR(dsn="shp/study_area.shp", layer="study_area")
sites <- readOGR(dsn="shp/sites.shp", layer="sites")
area <- as(studyarea,"owin")
sppp <- ppp(x=sites$utmx, y=sites$utmy, window=area)
slope <- raster("grids/slope_monforte.tif")
wetland_cost <- raster("grids/wetland_cost_monforte.tiff")
hydro_cost <- raster("grids/hydrology_cost_monforte.tiff")
visual_prom <- raster("grids/visual_prominence_monforte.tif")
```

### Achieve monovariate patron

```{r echo=TRUE, results='hide'}
elev <- as.im(as(elevation,"SpatialGridDataFrame"))
slo <- as.im(as(slope,"SpatialGridDataFrame"))
wetl <- as.im(as(wetland_cost,"SpatialGridDataFrame"))
hydro <- as.im(as(hydro_cost,"SpatialGridDataFrame"))
vipro <- as.im(as(visual_prom,"SpatialGridDataFrame"))
```

### Intensity function

```{r echo=TRUE, results='hide'}
elev.rh <- rhohat(sppp, elev, confidence=0.95)
slo.rh <- rhohat(sppp, slo, confidence=0.95)
wetl.rh <- rhohat(sppp, wetl, confidence=0.95)
hydro.rh <- rhohat(sppp, hydro, confidence=0.95)
vipro.rh <- rhohat(sppp, vipro, confidence=0.95)
```

### Elevation function

```{r echo=TRUE, results='hide'}
plot(elev.rh, main= "", xlab="m.a.s.l", ylab="", xlim=c(250,500), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Altitude", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1B.pdf",width = 5,height = 12)
```

### Slope function

```{r echo=TRUE, results='hide'}
plot(slo.rh, main= "", xlab="Grades", ylab="", xlim=c(0,6.8), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Slope", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1C.pdf",width = 5,height = 12)
```

### Cost to potential hydrology

```{r echo=TRUE, results='hide'}
plot(hydro.rh, main= "", xlab="Seconds", ylab="", xlim=c(0,6500), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Cost to potential hydrology", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1D.pdf",width = 5,height = 12)
```

### Cost to wetland areas

```{r echo=TRUE, results='hide'}
plot(wetl.rh, main= "", xlab="Seconds", ylab="", xlim=c(0,1150), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Cost to wetland areas", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1E.pdf",width = 5,height = 12)
```

### Visual prominence

```{r echo=TRUE, results='hide'}
plot(vipro.rh, main= "", xlab="Index", ylab="", xlim=c(0,105), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Visual prominence", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1F.pdf",width = 5,height = 12)
```

# Barplots (sites vs terrain)

### Import data

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
altplot <- read.table(file="csv/altplot.csv",header=TRUE, sep=";")
altplot1 <- read.table(file="csv/altplot1.csv",header=TRUE, sep=";")
altplot2 <- read.table(file="csv/altplot2.csv",header=TRUE, sep=";")
altplot3 <- read.table(file="csv/altplot3.csv",header=TRUE, sep=";")
altplot4 <- read.table(file="csv/altplot4.csv",header=TRUE, sep=";")
```

### Altitude

```{r echo=TRUE, results='hide'}
altplot$Altitud <- factor (altplot$Altitude, levels = c("0-100", "100-200","200-300","300-400","400-500","500-600","600-700","700-800","800-900","900-1000","1000-1100","1100-1200","1200-1300","1300-1400","1400-1500"))  
p <- ggplot(altplot,aes(Altitude,Percentage)) + geom_bar(data=subset(altplot,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold")) + labs(title = "", y = "Percentage", x = "Altitude (masl)")  
p <- p + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p)
pdf(file = "~output/Figura2A.pdf",width = 5,height = 12)
```

### Slope

```{r echo=TRUE, results='hide'}
altplot1$Slope <- factor (altplot1$Slope, levels = c("0-5", "5-10","10-15","15-20","20-25","25-30","30-35","35-40","40-45","45-50","50-55","55-60","60-65"))  
p1 <- ggplot(altplot1,aes(Slope,Percentage)) + geom_bar(data=subset(altplot1,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot1,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))+ labs(title = "", y = "Percentage", x = "Slope (grades)")   
p1 <- p1 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p1)
pdf(file = "~output/Figura2B.pdf",width = 5,height = 12)
```

### Cost to potential hydrology

```{r echo=TRUE, results='hide'}
altplot2$Cost <- factor (altplot2$Cost, levels = c("0-1000", "1000-2000","2000-3000","3000-4000","4000-5000","5000-6000","6000-7000","7000-8000","8000-9000","9000-10000","10000-11000","11000-12000","12000-13000"))  
p2 <- ggplot(altplot2,aes(Cost,Percentage)) + geom_bar(data=subset(altplot2,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot2,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))+ labs(title = "", y = "Percentage", x = "Cost to potental hydrology (seconds)")   
p2 <- p2 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p2)
pdf(file = "~output/Figura2C.pdf",width = 5,height = 12)
```


### Kernel density estimation methods for cluster analysis selection

```{r echo=TRUE, results='hide'}
# bw.diggle estimation method
a <- bw.diggle(sitesSub.ppp)
a
plot(a, main="a. Likelihood crooss-validation bw.diggle criterion for smoothing bandwith")
pdf(file = "~output/Figure2a.pdf",width = 5,height = 12)

# bw.ppl estimation method
b <- bw.ppl(sitesSub.ppp)
b
plot(b, main="b. Likelihood cross-validation bw.ppl criterion for smoothing bandwith")
pdf(file = "~output/Figure2b.pdf",width = 5,height = 12)

# bw.scott estimation method
c <- bw.scott(sitesSub.ppp)
c
plot(c, main="c. Bandwith selection in multidimensional smoothing with bw.scott method")
pdf(file = "~output/Figure2c.pdf",width = 5,height = 12)

# bw.frac estimation method
d <- bw.frac(sitesSub.ppp)
d
plot(d, main="d. Bandwith selection rule based on the window geometry with bw.frac method")
pdf(file = "~output/Figure2d.pdf",width = 5,height = 12)

# bw.CvL estimation method
e <- bw.CvL(sitesSub.ppp) 
e
plot(e, main="e. Smoothing bandwith selection based on Cambell's formula with bw.CvL method")
pdf(file = "~output/Figure2e.pdf",width = 5,height = 12)
```

### KDE

Kernel density estimation analysis for the best sigmas established in the previous step.

```{r echo=TRUE, results='hide'}
plot(density(sitesSub.ppp, sigma = 413.4299), main="a. Kernel Density (sigma = 0.41 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3a.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 5314.439), main="b. Kernel Density (sigma = 5.31 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3b.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 14180.02), main="c. Kernel Density (sigma = 14.18 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3c.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 17790.83), main="d. Kernel Density (sigma = 17.79 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3d.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 25282.11), main="e. Kernel Density (sigma = 25.28 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3e.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 56825.16), main="f. Kernel Density (sigma = 56.83 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3f.pdf",width = 4,height = 4)
```

### Quadrat Test

```{r echo=TRUE, results='hide'}
# plot the points
plot(sitesSub.ppp,pch=16,cex=0.5, main="g. Quadrat Test results")
# count the points in that fall in a 6 x 6 grid overlaid across the window
plot(quadratcount(sitesSub.ppp, nx = 6, ny = 6),add=T,col="red")
pdf(file = "~output/Figure3g.pdf",width = 8,height = 8)

# if the p-value of Chi-Squared test is > 0.05, then we can reject a null hyphothesis that says "there is no complete spatial randomness in our data". If p-value is > 0.05 then this indicates that we have CSR and there is no pattern in our points. If it is < 0.05, this indicates that we do have clustering in our points.
teststats <- quadrat.test(sitesSub.ppp, nx = 6, ny = 6)

teststats


# the top-left value is the observed count of points; the top-right is the Poisson expected number of points; the bottom value is the Pearson residual value, or (Observed - Expected) / Sqrt(Expected).
plot(sitesSub.ppp,pch=16,cex=0.5, main="h. Quadrat Test Stats results")
plot(teststats, add=T, col = "red")
pdf(file = "~output/Figure3h.pdf",width = 8,height = 8)
```

### K, L and G Functions

```{r echo=TRUE, results='hide'}
# set the simulations
sims <- 99
# to get 95% envelope
nrank <- round((sims + 1) / 100 * 2.5, 0) 

# Kfunction sites
Kfunction <- envelope(sitesSub.ppp,Kest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(Kfunction,main="a. K Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4a.pdf",width = 5,height = 12)
# Inhomogeneous
KinhomFunction <- envelope(sitesSub.ppp,Kinhom, nsim=sims,rank=nrank, correction="best") 
plot(KinhomFunction,main="b. K Function (inhomogeneous)",legend=FALSE)
pdf(file = "~output/Figure4b.pdf",width = 5,height = 12)

# LFunction sites
LFunction <- envelope(sitesSub.ppp,Lest, nsim=sims,rank=nrank, correction="best")
# Homogeneous
plot(LFunction,main="c. L Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4c.pdf",width = 5,height = 12)
# Inhomogeneous
LinhomFunction <- envelope(sitesSub.ppp,Linhom, nsim=sims,rank=nrank, correction="best")
plot(LinhomFunction,main="d. L Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4d.pdf",width = 5,height = 12)

# GFunction sites
GFunction <- envelope(sitesSub.ppp,Gest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(GFunction,main="e. G Function (homogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4e.pdf",width = 5,height = 12)
# Inhomogeneous
GinhomFunction <- envelope(sitesSub.ppp,Ginhom, nsim=sims,rank=nrank, correction="best") 
plot(GinhomFunction,main="f. G Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4f.pdf",width = 5,height = 12)
```

### Other statistical tests

Different statistical tests to analyse the sample of sites.

```{r echo=TRUE, results='hide'}
# X2 test sites
chisq.test(sites$Easting,sites$Northing)

# DCLF Test 
dclf.test(sitesSub.ppp)

# Clark and Evans Test
clarkevans.test(sitesSub.ppp)

# Hopkins-Skellam Test 
hopskel.test(sitesSub.ppp, alternative=c("clustered"),method=c("MonteCarlo"),nsim=999)
```

# Kmeans analysis
### Import data

```{r echo=TRUE, results='hide'}
# set the working directory
setwd("~/xls")
data <- read_excel("data.xls")
View(data)

# remove any missing value that might be present in the data
df <- na.omit(data)

# start by scaling/standardizing the data 
df <- scale(df)
head(df) 

# for computing a distance matrix between the rows of a data matrix for Euclidean distance
distance <- get_dist(df) 
```

### Optimal number of clusters

```{r echo=TRUE, results='hide'}
# all indices included to be calculated
resnumclust <- NbClust(df, distance = "euclidean", min.nc=2, max.nc=24, method = "kmeans", index = "alllong")
fviz_nbclust(resnumclust)
```

### Cluster distribution

```{r echo=TRUE, results='hide'}
# clusters
k2 <- kmeans(df, centers = 2, nstart = 25) #test with 2 clusters
k5 <- kmeans(df, centers = 5, nstart = 25) #test with 5 clusters
k7 <- kmeans(df, centers = 7, nstart = 25) #test with 7 clusters
k13 <- kmeans(df, centers = 13, nstart = 25) #test with 13 clusters

# plot the clusters
p1 <- df %>%
  as_tibble() %>%
  mutate(cluster = k2$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point()  + theme_bw() + labs(title = "Kmeans (N=2)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

p2 <- df %>%
  as_tibble() %>%
  mutate(cluster = k5$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point() + theme_bw() +labs(title = "Kmeans (N=5)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

p3 <- df %>%
  as_tibble() %>%
  mutate(cluster = k7$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point() + theme_bw() +labs(title = "Kmeans (N=7)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

p4 <- df %>%
  as_tibble() %>%
  mutate(cluster = k13$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point() + theme_bw() +labs(title = "Kmeans (N=13)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

# plot comparing the 4 clusters (N=2/N=13)
grid.arrange(p1, p2, p3, p4, nrow = 2)
pdf(file = "~output/Figure4f.pdf",width = 6,height = 10)
```

# DBSCAN analysis
### Import data

```{r echo=TRUE, results='hide'}
# set the working directory
setwd("~/shp")

# EPSG string to help set the projection 
BNG = "+init=epsg:25829"
# read the data in
studyarea <- readShapePoly("Galicia.shp", proj4string = CRS(BNG))
# check it is worked
plot(studyarea)

# add the sites
sites <- readShapePoints("sites.shp", proj4string = CRS(BNG))
# plot the studyarea and the sites and check everything looks ok
plot(sites, col="blue", pch=20, add=T)

# remove any sites with the same grid reference
sites <- remove.duplicates(sites)
# select the points inside the studyarea 
sitesSub <- sites[studyarea,]
# check to see that they have been removed
plot(studyarea)
plot(sitesSub, col="red", pch=20, add=T) 

# set a window as the studyarea
window <- as.owin(studyarea)
plot(window)

# create a ppp object
sitesSub.ppp <- ppp(x=sitesSub$Easting,y=sitesSub$Northing,window=window)

# this option is to check the coordinate reference system of the spatial polygon:
crs(studyarea)

# extract the points from the spatial points data frame
sitesPoints <- data.frame(x=sitesSub$Easting,y=sitesSub$Northing)
```

### Evaluation of eps

```{r echo=TRUE, results='hide'}
# indicate min_pts
min_pts <- 4


# evaluate the eps and chose the value
A <- dbscan::kNNdist(sitesPoints, k = min_pts)
Eps <- A[order(A)]
plot(Eps)

abline(h=6000, col = "red", lty=2) + title("a.Evaluation of eps")
pdf(file = "~output/Figure7a.pdf",width = 5,height = 12)
```

### Create DBSCAN

```{r echo=TRUE, results='hide'}
# run the dbscan analysis for different eps
db1 <- fpc::dbscan(sitesPoints, eps = 1000, MinPts = 4)

db2 <- fpc::dbscan(sitesPoints, eps = 6000, MinPts = 4) 

db3 <- fpc::dbscan(sitesPoints, eps = 10000, MinPts = 4) 

db4 <- fpc::dbscan(sitesPoints, eps = 20000, MinPts = 4)

# create a ggplot2 object from the data
cluster1 <- as.factor(as.character(db1$cluster))
p1 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster1, factor(cluster1))) + 
  geom_point()+ theme_bw() + labs(title = "DBSCAN Cluster (eps = 1000)", y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru", "seagreen", "seashell3", "violetred", "yellow1", "tan2", "slateblue4", "plum2", "mediumspringgreen", "lightsteelblue1", "lightsalmon1", "khaki4", "lightcoral", "mediumspringgreen", "lightyellow1", "maroon3", "olivedrab4", "midnightblue", "navajowhite4")) + labs(colour = "Cluster Number")
plot(p1)

cluster2 <- as.factor(as.character(db2$cluster))
p2 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster2)) + 
  geom_point()+ theme_bw() + labs(title = "DBSCAN Cluster (eps = 6000)",y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru", "seagreen", "seashell3", "violetred", "yellow1", "tan2", "slateblue4", "plum2", "mediumspringgreen", "lightsteelblue1", "lightsalmon1")) + labs(colour = "Cluster Number")
plot(p2)

cluster3 <- as.factor(as.character(db3$cluster))
p3 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster3)) + 
  geom_point()+ theme_bw() + labs(title = "DBSCAN Cluster (eps = 10000)",y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru", "seagreen", "seashell3", "violetred", "yellow1", "tan2", "slateblue4")) + labs(colour = "Cluster Number")
plot(p3)

cluster4 <- as.factor(as.character(db4$cluster))
p4 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster4)) + 
  geom_point() + theme_bw() + labs(title = "DBSCAN Cluster (eps = 20000)",y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru")) + labs(colour = "Cluster Number")
plot(p4)


grid.arrange(p1, p2, p3, p4, nrow = 2)
pdf(file = "~output/Figure7b-e.pdf",width = 8,height = 12)
```

# Percolation analysis
### Import data

```{r echo=TRUE, results='hide'}

# set the working directory. The process create new folders in that directory for the results
setwd("~/percolation")

# import sites
data <- read_excel("data.xls")

# import studyarea
Gal_shape <- readOGR(dsn="Galicia.shp", layer="Galicia")
```

### Analysis

```{r echo=TRUE, results='hide'}
# percolation
percolate (data, ,40, 2, 1, 50, 1000)

# create maps
map_name <- "Percolation distance"
dpi <- 300

# create the cluster maps
mapClusters(Gal_shape,map_name,"cluster",dpi)

# create graphs
plotClustFreq ("analysis_by_radius.csv")
=======
---
title: "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin (NW Iberian Peninsula)"
author: "Mikel Diaz-Rodriguez and Ramon Fabregas-Valcarce"
date: "March 9th, 2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE,
                      echo = TRUE)
```

# Introduction

This document contains code to enable reproducibility of the paper "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin (NW Iberian Peninsula)".

The steps indicated in the following lines allow to reproduce the analyses carried out.

# Packages used
### Import the packages

```{r echo=TRUE, results='hide'}
# ipak function: install and load multiple R packages.

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
# install all the packages
packages <- c("GGally", "spatstat","dismo", "MASS", "ggplot2", "plyr", "sp","maps","maptools","raster","geostatsp","rgdal")
ipak(packages)
```


# Complete Spatial Randomness
### Import the data used in CSR analysis

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# set the projection 
BNG = "+init=epsg:25829"

# add the study area 
studyarea <- readShapePoly("study_area.shp", proj4string = CRS(BNG))

# and check it is worked
plot(studyarea)

# add the sites
sites <- readShapePoints("sites.shp", proj4string = CRS(BNG))

# add the random points
random_sites <- readShapePoints("random_sites.shp", proj4string = CRS(BNG))

# plot the studyarea and the sites and check everything looks ok
plot(sites, col="blue", pch=20, add=T)

# remove any sites with the same grid reference
sites <- remove.duplicates(sites)

# select the points inside the studyarea 
sitesSub <- sites[studyarea,]

# check to see that they have been removed
plot(studyarea)
plot(sitesSub, col="red", pch=20, add=T)

# set a window as the studyarea
window <- as.owin(studyarea)
plot(window)

# create a ppp object
sitesSub.ppp <- ppp(x=sitesSub$UTMX,y=sitesSub$UTMY,window=window)

# plot the sites and the studyarea
plot(sitesSub.ppp,pch=16,cex=0.5, main="Palaeolithic archaeological sites")
```

### Shapiro-Wilk Test

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# Shapiro-Wilk Test
shapiro.test(sites$UTMX)
```

### K-S Test

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# K-S sites vs random sites
ks.test(sites$UTMX,random_sites$UTMX)
```

### X2 Test

```{r echo=TRUE, results='hide'}
# X2 test sites
chisq.test(sites$UTMX,sites$UTMX)
```

### K, L and G Functions

```{r echo=TRUE, results='hide'}
# set the simulations
sims <- 99
# to get 95% envelope
nrank <- round((sims + 1) / 100 * 2.5, 0) 

# Kfunction sites
Kfunction <- envelope(sitesSub.ppp,Kest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(Kfunction,main="a. K Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4a.pdf",width = 5,height = 12)
# Inhomogeneous
KinhomFunction <- envelope(sitesSub.ppp,Kinhom, nsim=sims,rank=nrank, correction="best") 
plot(KinhomFunction,main="b. K Function (inhomogeneous)",legend=FALSE)
pdf(file = "~output/Figure4b.pdf",width = 5,height = 12)

# LFunction sites
LFunction <- envelope(sitesSub.ppp,Lest, nsim=sims,rank=nrank, correction="best")
# Homogeneous
plot(LFunction,main="c. L Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4c.pdf",width = 5,height = 12)
# Inhomogeneous
LinhomFunction <- envelope(sitesSub.ppp,Linhom, nsim=sims,rank=nrank, correction="best")
plot(LinhomFunction,main="d. L Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4d.pdf",width = 5,height = 12)

# GFunction sites
GFunction <- envelope(sitesSub.ppp,Gest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(GFunction,main="e. G Function (homogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4e.pdf",width = 5,height = 12)
# Inhomogeneous
GinhomFunction <- envelope(sitesSub.ppp,Ginhom, nsim=sims,rank=nrank, correction="best") 
plot(GinhomFunction,main="f. G Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4f.pdf",width = 5,height = 12)
```

# Pearson's Correlation

```{r echo=TRUE, results='hide'}
# Set the working directory
setwd("~/xls")

# Data
sample_data <- data.frame(v1=dat$altitude,v2=dat$wetland_cost,v3=dat$goat_cost,v5=dat$geology_cost,v6=dat$hydrology_cost,v7=dat$lcp_cost,v8=dat$eucl_dist_geo,v9=dat$eucl_dist_hydro,v10=dat$dif_ins,v11=dat$dir_ins,v12=dat$tot_ins,v13=dat$aspect,v14=dat$slope,v15=dat$vis_prom,v16=dat$tpi100,v17=dat$tpi500,v18=dat$tpi1000,v19=dat$wind)

# Check correlations
cor(sample_data)

# Check correlations as scatterplots, distributions and correlation coeficient.
ggpairs(sample_data)

# Visualization
ggcorr(sample_data, method=c("everything", "pearson"))

# Export file
pdf(file = "~output/Figure2a.pdf",width = 5,height = 12)
```

# GLM

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# ad the shapefile
locations <- readOGR(dsn="locations.shp", layer="locations")

# set the working directory
setwd("~/grids")

# Import variables and set the same extent for everyone
elevation <- raster("dem_monforte.tif")
tot_ins <- raster("total_insolation_monforte.asc")
tot_inso <- projectRaster(tot_ins, elevation)
asp <- raster("aspect_monforte.tif")
aspect <- projectRaster(asp, elevation)
slop <- raster("slope_monforte.tif")
slope <- projectRaster(slop, elevation)
vis_prom <- raster("visual_prominence_monforte.tif")
visual_prom <- projectRaster(vis_prom, elevation)
tpi100_monf <- raster("tpi100_monforte.asc")
tpi100 <- projectRaster(tpi100_monf, elevation)

tpi500_monf <- raster("tpi500_monforte.asc")
tpi500 <- projectRaster(tpi500_monf, elevation)

wind_monf <- raster("wind_monforte.asc")
wind <- projectRaster(wind_monf, elevation)

c_branhas <- raster("coste_branhas_monforte.tiff")
coste_branhas <- projectRaster(c_branhas, elevation)
c_cabras <- raster("coste_cabras_monforte.tiff")
coste_cabras <- projectRaster(c_cabras, elevation)
c_ciervos <- raster("coste_ciervos_monforte.tiff")
coste_ciervos <- projectRaster(c_ciervos, elevation)
c_geo2 <- raster("coste_geologia_monforte2.tiff")
coste_geologia <- projectRaster(c_geo2, elevation)
c_hidro <- raster("coste_hidrologia_monforte.tiff")
coste_hidrologia <- projectRaster(c_hidro, elevation)
c_rutas <- raster("coste_rutas_monforte.tiff")
coste_rutas <- projectRaster(c_rutas, elevation)
dist_eucl_geo <- raster("distancia_euclidiana_geologia_monforte2.tif")
dist_eucl_geologia <- projectRaster(dist_eucl_geo, elevation)
dist_eucl_hidro <- raster("distancia_euclidiana_hidrologia_monforte2.tif")
dist_eucl_hidrologia <- projectRaster(dist_eucl_hidro, elevation)
```

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
#Creación del modelo de regresión generalizada
covariates <- stack(elevation, tot_inso, aspect, slope, visual_prom, tpi100, coste_branhas, coste_geologia,coste_hidrologia, coste_rutas, wind, tpi500)
names(covariates) <- c("elevation", "tot_inso", "aspect", "slope", "visual_prom", "tpi100", "coste_branhas", "coste_geologia","coste_hidrologia", "coste_rutas", "viento", "tpi500")
locvals <- data.frame(extract(covariates, locations))
locvals$site <- locations$CID==1
```

### Kernel density estimation methods for cluster analysis selection

```{r echo=TRUE, results='hide'}
# bw.diggle estimation method
a <- bw.diggle(sitesSub.ppp)
a
plot(a, main="a. Likelihood crooss-validation bw.diggle criterion for smoothing bandwith")
pdf(file = "~output/Figure2a.pdf",width = 5,height = 12)

# bw.ppl estimation method
b <- bw.ppl(sitesSub.ppp)
b
plot(b, main="b. Likelihood cross-validation bw.ppl criterion for smoothing bandwith")
pdf(file = "~output/Figure2b.pdf",width = 5,height = 12)

# bw.scott estimation method
c <- bw.scott(sitesSub.ppp)
c
plot(c, main="c. Bandwith selection in multidimensional smoothing with bw.scott method")
pdf(file = "~output/Figure2c.pdf",width = 5,height = 12)

# bw.frac estimation method
d <- bw.frac(sitesSub.ppp)
d
plot(d, main="d. Bandwith selection rule based on the window geometry with bw.frac method")
pdf(file = "~output/Figure2d.pdf",width = 5,height = 12)

# bw.CvL estimation method
e <- bw.CvL(sitesSub.ppp) 
e
plot(e, main="e. Smoothing bandwith selection based on Cambell's formula with bw.CvL method")
pdf(file = "~output/Figure2e.pdf",width = 5,height = 12)
```

### KDE

Kernel density estimation analysis for the best sigmas established in the previous step.

```{r echo=TRUE, results='hide'}
plot(density(sitesSub.ppp, sigma = 413.4299), main="a. Kernel Density (sigma = 0.41 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3a.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 5314.439), main="b. Kernel Density (sigma = 5.31 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3b.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 14180.02), main="c. Kernel Density (sigma = 14.18 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3c.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 17790.83), main="d. Kernel Density (sigma = 17.79 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3d.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 25282.11), main="e. Kernel Density (sigma = 25.28 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3e.pdf",width = 4,height = 4)

plot(density(sitesSub.ppp, sigma = 56825.16), main="f. Kernel Density (sigma = 56.83 km)")
points(sites$Easting, sites$Northing, pch = 16, cex = 0.2, col = "black")
pdf(file = "~output/Figure3f.pdf",width = 4,height = 4)
```

### Quadrat Test

```{r echo=TRUE, results='hide'}
# plot the points
plot(sitesSub.ppp,pch=16,cex=0.5, main="g. Quadrat Test results")
# count the points in that fall in a 6 x 6 grid overlaid across the window
plot(quadratcount(sitesSub.ppp, nx = 6, ny = 6),add=T,col="red")
pdf(file = "~output/Figure3g.pdf",width = 8,height = 8)

# if the p-value of Chi-Squared test is > 0.05, then we can reject a null hyphothesis that says "there is no complete spatial randomness in our data". If p-value is > 0.05 then this indicates that we have CSR and there is no pattern in our points. If it is < 0.05, this indicates that we do have clustering in our points.
teststats <- quadrat.test(sitesSub.ppp, nx = 6, ny = 6)

teststats


# the top-left value is the observed count of points; the top-right is the Poisson expected number of points; the bottom value is the Pearson residual value, or (Observed - Expected) / Sqrt(Expected).
plot(sitesSub.ppp,pch=16,cex=0.5, main="h. Quadrat Test Stats results")
plot(teststats, add=T, col = "red")
pdf(file = "~output/Figure3h.pdf",width = 8,height = 8)
```

### K, L and G Functions

```{r echo=TRUE, results='hide'}
# set the simulations
sims <- 99
# to get 95% envelope
nrank <- round((sims + 1) / 100 * 2.5, 0) 

# Kfunction sites
Kfunction <- envelope(sitesSub.ppp,Kest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(Kfunction,main="a. K Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4a.pdf",width = 5,height = 12)
# Inhomogeneous
KinhomFunction <- envelope(sitesSub.ppp,Kinhom, nsim=sims,rank=nrank, correction="best") 
plot(KinhomFunction,main="b. K Function (inhomogeneous)",legend=FALSE)
pdf(file = "~output/Figure4b.pdf",width = 5,height = 12)

# LFunction sites
LFunction <- envelope(sitesSub.ppp,Lest, nsim=sims,rank=nrank, correction="best")
# Homogeneous
plot(LFunction,main="c. L Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4c.pdf",width = 5,height = 12)
# Inhomogeneous
LinhomFunction <- envelope(sitesSub.ppp,Linhom, nsim=sims,rank=nrank, correction="best")
plot(LinhomFunction,main="d. L Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4d.pdf",width = 5,height = 12)

# GFunction sites
GFunction <- envelope(sitesSub.ppp,Gest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(GFunction,main="e. G Function (homogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4e.pdf",width = 5,height = 12)
# Inhomogeneous
GinhomFunction <- envelope(sitesSub.ppp,Ginhom, nsim=sims,rank=nrank, correction="best") 
plot(GinhomFunction,main="f. G Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4f.pdf",width = 5,height = 12)
```

### Other statistical tests

Different statistical tests to analyse the sample of sites.

```{r echo=TRUE, results='hide'}
# X2 test sites
chisq.test(sites$Easting,sites$Northing)

# DCLF Test 
dclf.test(sitesSub.ppp)

# Clark and Evans Test
clarkevans.test(sitesSub.ppp)

# Hopkins-Skellam Test 
hopskel.test(sitesSub.ppp, alternative=c("clustered"),method=c("MonteCarlo"),nsim=999)
```

# Kmeans analysis
### Import data

```{r echo=TRUE, results='hide'}
# set the working directory
setwd("~/xls")
data <- read_excel("data.xls")
View(data)

# remove any missing value that might be present in the data
df <- na.omit(data)

# start by scaling/standardizing the data 
df <- scale(df)
head(df) 

# for computing a distance matrix between the rows of a data matrix for Euclidean distance
distance <- get_dist(df) 
```

### Optimal number of clusters

```{r echo=TRUE, results='hide'}
# all indices included to be calculated
resnumclust <- NbClust(df, distance = "euclidean", min.nc=2, max.nc=24, method = "kmeans", index = "alllong")
fviz_nbclust(resnumclust)
```

### Cluster distribution

```{r echo=TRUE, results='hide'}
# clusters
k2 <- kmeans(df, centers = 2, nstart = 25) #test with 2 clusters
k5 <- kmeans(df, centers = 5, nstart = 25) #test with 5 clusters
k7 <- kmeans(df, centers = 7, nstart = 25) #test with 7 clusters
k13 <- kmeans(df, centers = 13, nstart = 25) #test with 13 clusters

# plot the clusters
p1 <- df %>%
  as_tibble() %>%
  mutate(cluster = k2$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point()  + theme_bw() + labs(title = "Kmeans (N=2)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

p2 <- df %>%
  as_tibble() %>%
  mutate(cluster = k5$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point() + theme_bw() +labs(title = "Kmeans (N=5)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

p3 <- df %>%
  as_tibble() %>%
  mutate(cluster = k7$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point() + theme_bw() +labs(title = "Kmeans (N=7)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

p4 <- df %>%
  as_tibble() %>%
  mutate(cluster = k13$cluster,
         state = row.names(data)) %>%
  ggplot(aes(data$Easting, data$Northing, color = factor(cluster), label = state)) +
  geom_point() + theme_bw() +labs(title = "Kmeans (N=13)",y= "UTM Y", x = "UTM X",colour = "Cluster") 

# plot comparing the 4 clusters (N=2/N=13)
grid.arrange(p1, p2, p3, p4, nrow = 2)
pdf(file = "~output/Figure4f.pdf",width = 6,height = 10)
```

# DBSCAN analysis
### Import data

```{r echo=TRUE, results='hide'}
# set the working directory
setwd("~/shp")

# EPSG string to help set the projection 
BNG = "+init=epsg:25829"
# read the data in
studyarea <- readShapePoly("Galicia.shp", proj4string = CRS(BNG))
# check it is worked
plot(studyarea)

# add the sites
sites <- readShapePoints("sites.shp", proj4string = CRS(BNG))
# plot the studyarea and the sites and check everything looks ok
plot(sites, col="blue", pch=20, add=T)

# remove any sites with the same grid reference
sites <- remove.duplicates(sites)
# select the points inside the studyarea 
sitesSub <- sites[studyarea,]
# check to see that they have been removed
plot(studyarea)
plot(sitesSub, col="red", pch=20, add=T) 

# set a window as the studyarea
window <- as.owin(studyarea)
plot(window)

# create a ppp object
sitesSub.ppp <- ppp(x=sitesSub$Easting,y=sitesSub$Northing,window=window)

# this option is to check the coordinate reference system of the spatial polygon:
crs(studyarea)

# extract the points from the spatial points data frame
sitesPoints <- data.frame(x=sitesSub$Easting,y=sitesSub$Northing)
```

### Evaluation of eps

```{r echo=TRUE, results='hide'}
# indicate min_pts
min_pts <- 4


# evaluate the eps and chose the value
A <- dbscan::kNNdist(sitesPoints, k = min_pts)
Eps <- A[order(A)]
plot(Eps)

abline(h=6000, col = "red", lty=2) + title("a.Evaluation of eps")
pdf(file = "~output/Figure7a.pdf",width = 5,height = 12)
```

### Create DBSCAN

```{r echo=TRUE, results='hide'}
# run the dbscan analysis for different eps
db1 <- fpc::dbscan(sitesPoints, eps = 1000, MinPts = 4)

db2 <- fpc::dbscan(sitesPoints, eps = 6000, MinPts = 4) 

db3 <- fpc::dbscan(sitesPoints, eps = 10000, MinPts = 4) 

db4 <- fpc::dbscan(sitesPoints, eps = 20000, MinPts = 4)

# create a ggplot2 object from the data
cluster1 <- as.factor(as.character(db1$cluster))
p1 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster1, factor(cluster1))) + 
  geom_point()+ theme_bw() + labs(title = "DBSCAN Cluster (eps = 1000)", y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru", "seagreen", "seashell3", "violetred", "yellow1", "tan2", "slateblue4", "plum2", "mediumspringgreen", "lightsteelblue1", "lightsalmon1", "khaki4", "lightcoral", "mediumspringgreen", "lightyellow1", "maroon3", "olivedrab4", "midnightblue", "navajowhite4")) + labs(colour = "Cluster Number")
plot(p1)

cluster2 <- as.factor(as.character(db2$cluster))
p2 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster2)) + 
  geom_point()+ theme_bw() + labs(title = "DBSCAN Cluster (eps = 6000)",y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru", "seagreen", "seashell3", "violetred", "yellow1", "tan2", "slateblue4", "plum2", "mediumspringgreen", "lightsteelblue1", "lightsalmon1")) + labs(colour = "Cluster Number")
plot(p2)

cluster3 <- as.factor(as.character(db3$cluster))
p3 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster3)) + 
  geom_point()+ theme_bw() + labs(title = "DBSCAN Cluster (eps = 10000)",y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru", "seagreen", "seashell3", "violetred", "yellow1", "tan2", "slateblue4")) + labs(colour = "Cluster Number")
plot(p3)

cluster4 <- as.factor(as.character(db4$cluster))
p4 <- ggplot(data=sitesPoints, aes(x=sitesSub$Easting, y=sitesSub$Northing, colour=cluster4)) + 
  geom_point() + theme_bw() + labs(title = "DBSCAN Cluster (eps = 20000)",y= "UTM Y", x = "UTM X") + 
  scale_color_manual(values = c("oldlace", "#2E9FDF", "#FC4E07","peru")) + labs(colour = "Cluster Number")
plot(p4)


grid.arrange(p1, p2, p3, p4, nrow = 2)
pdf(file = "~output/Figure7b-e.pdf",width = 8,height = 12)
```

# Percolation analysis
### Import data

```{r echo=TRUE, results='hide'}

# set the working directory. The process create new folders in that directory for the results
setwd("~/percolation")

# import sites
data <- read_excel("data.xls")

# import studyarea
Gal_shape <- readOGR(dsn="Galicia.shp", layer="Galicia")
```

### Analysis

```{r echo=TRUE, results='hide'}
# percolation
percolate (data, ,40, 2, 1, 50, 1000)

# create maps
map_name <- "Percolation distance"
dpi <- 300

# create the cluster maps
mapClusters(Gal_shape,map_name,"cluster",dpi)

# create graphs
plotClustFreq ("analysis_by_radius.csv")
>>>>>>> 64b4e042764d12b38bda959044137e504fb929b8
```