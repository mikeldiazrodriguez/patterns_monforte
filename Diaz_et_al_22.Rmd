---
title: "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin (NW Iberian Peninsula)"
author: "Mikel Diaz-Rodriguez and Ramon Fabregas-Valcarce"
date: "March 10th, 2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE,
                      echo = TRUE)
```

# Introduction

This document contains code to enable reproducibility of the paper "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin (NW Iberian Peninsula)".

The steps indicated in the following lines allow to reproduce the analyses carried out.

# Packages used
### Import the packages

```{r echo=TRUE, results='hide'}
# ipak function: install and load multiple R packages.

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
# install all the packages
packages <- c("GGally", "spatstat", "dismo", "MASS", "ggplot2", "plyr", "sp", "maps", "maptools", "raster", "geostatsp", "rgdal")
ipak(packages)
```


# Complete Spatial Randomness
### Import the data used in CSR analysis

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# set the projection 
BNG = "+init=epsg:25829"

# add the study area 
studyarea <- readShapePoly("study_area.shp", proj4string = CRS(BNG))
studyarea <- readOGR(dsn="study_area.shp", layer="study_area")

# and check it is worked
plot(studyarea)

# add the sites
sites <- readShapePoints("sites.shp", proj4string = CRS(BNG))
sites <- readOGR(dsn="sites.shp", layer="sites")

# add the random points
random_sites <- readShapePoints("random_sites.shp", proj4string = CRS(BNG))
random_sites <- readOGR(dsn="random_sites.shp", layer="random_sites")

# plot the studyarea and the sites and check everything looks ok
plot(sites, col="blue", pch=20, add=T)

# remove any sites with the same grid reference
sites <- remove.duplicates(sites)

# select the points inside the studyarea 
sitesSub <- sites[studyarea,]

# check to see that they have been removed
plot(studyarea)
plot(sitesSub, col="red", pch=20, add=T)

# set a window as the studyarea
window <- as.owin(studyarea)
plot(window)

# create a ppp object
sitesSub.ppp <- ppp(x=sitesSub$UTMX,y=sitesSub$UTMY,window=window)

# plot the sites and the studyarea
plot(sitesSub.ppp,pch=16,cex=0.5, main="Palaeolithic archaeological sites")
```

### Shapiro-Wilk Test

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# Shapiro-Wilk Test
shapiro.test(sites$UTMX)
```

### K-S Test

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# K-S sites vs random sites
ks.test(sites$UTMX,random_sites$UTMX)
```

### X2 Test

```{r echo=TRUE, results='hide'}
# X2 test sites
chisq.test(sites$UTMX,random_sites$UTMX)
```

### K, L and G Functions

```{r echo=TRUE, results='hide'}
# set the simulations
sims <- 99
# to get 95% envelope
nrank <- round((sims + 1) / 100 * 2.5, 0) 

# Kfunction sites
Kfunction <- envelope(sitesSub.ppp,Kest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(Kfunction,main="a. K Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4a.pdf",width = 5,height = 12)
# Inhomogeneous
KinhomFunction <- envelope(sitesSub.ppp,Kinhom, nsim=sims,rank=nrank, correction="best") 
plot(KinhomFunction,main="b. K Function (inhomogeneous)",legend=FALSE)
pdf(file = "~output/Figure4b.pdf",width = 5,height = 12)

# LFunction sites
LFunction <- envelope(sitesSub.ppp,Lest, nsim=sims,rank=nrank, correction="best")
# Homogeneous
plot(LFunction,main="c. L Function (homogeneous)",legend=FALSE)
pdf(file = "~output/Figure4c.pdf",width = 5,height = 12)
# Inhomogeneous
LinhomFunction <- envelope(sitesSub.ppp,Linhom, nsim=sims,rank=nrank, correction="best")
plot(LinhomFunction,main="d. L Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4d.pdf",width = 5,height = 12)

# GFunction sites
GFunction <- envelope(sitesSub.ppp,Gest, nsim=sims,rank=nrank, correction="best") 
# Homogeneous
plot(GFunction,main="e. G Function (homogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4e.pdf",width = 5,height = 12)
# Inhomogeneous
GinhomFunction <- envelope(sitesSub.ppp,Ginhom, nsim=sims,rank=nrank, correction="best") 
plot(GinhomFunction,main="f. G Function (inhomogeneous)",legend=FALSE) 
pdf(file = "~output/Figure4f.pdf",width = 5,height = 12)
```

# Pearson's Correlation

```{r echo=TRUE, results='hide'}
# Set the working directory
setwd("~/xls")

# Data
sample_data <- data.frame(v1=dat$altitude,v2=dat$wetland_cost,v3=dat$goat_cost,v5=dat$geology_cost,v6=dat$hydrology_cost,v7=dat$lcp_cost,v8=dat$eucl_dist_geo,v9=dat$eucl_dist_hydro,v10=dat$dif_ins,v11=dat$dir_ins,v12=dat$tot_ins,v13=dat$aspect,v14=dat$slope,v15=dat$vis_prom,v16=dat$tpi100,v17=dat$tpi500,v18=dat$tpi1000,v19=dat$wind)

# Check correlations
cor(sample_data)

# Check correlations as scatterplots, distributions and correlation coeficient.
ggpairs(sample_data)

# Visualization
ggcorr(sample_data, method=c("everything", "pearson"))

# Export file
pdf(file = "~output/Figure2a.pdf",width = 5,height = 12)
```

# GLM

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# ad the shapefile
locations <- readOGR(dsn="locations.shp", layer="locations")

# set the working directory
setwd("~/grids")

# Import variables and set the same extent for everyone
elevation <- raster("dem_monforte.tif")
tot_ins <- raster("total_insolation_monforte.asc")
tot_inso <- projectRaster(tot_ins, elevation)
asp <- raster("aspect_monforte.tif")
aspect <- projectRaster(asp, elevation)
slop <- raster("slope_monforte.tif")
slope <- projectRaster(slop, elevation)
vis_prom <- raster("visual_prominence_monforte.tif")
visual_prom <- projectRaster(vis_prom, elevation)
tpi100_monf <- raster("tpi100_monforte.asc")
tpi100 <- projectRaster(tpi100_monf, elevation)

tpi500_monf <- raster("tpi500_monforte.asc")
tpi500 <- projectRaster(tpi500_monf, elevation)

wind_monf <- raster("wind_monforte.asc")
wind <- projectRaster(wind_monf, elevation)
wetland_c <- raster("wetland_cost_monforte.tiff")
wetland_cost <- projectRaster(wetland_c, elevation)
goat_c <- raster("goat_cost_monforte.tiff")
goat_cost <- projectRaster(goat_c, elevation)
geol_c <- raster("geology_cost_monforte.tiff")
geol_cost <- projectRaster(geol_c, elevation)
hydro_c <- raster("hydrology_cost_monforte.tiff")
hydro_cost <- projectRaster(hydro_c, elevation)
lcp_c <- raster("lcp_cost_monforte.tiff")
lcp_cost <- projectRaster(lcp_c, elevation)

dist_eucl_geo <- raster("distancia_euclidiana_geologia_monforte2.tif")
dist_eucl_geologia <- projectRaster(dist_eucl_geo, elevation)
dist_eucl_hidro <- raster("distancia_euclidiana_hidrologia_monforte2.tif")
dist_eucl_hidrologia <- projectRaster(dist_eucl_hidro, elevation)
```

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# GLM creation
covariates <- stack(elevation, tot_inso, aspect, slope, visual_prom, tpi100, wetland_cost, geol_cost, hydro_cost, lcp_cost, wind, tpi500)
names(covariates) <- c("elevation", "tot_inso", "aspect", "slope", "visual_prom", "tpi100", "wetland_cost", "geol_cost","hydro_cost", "lcp_cost", "wind", "tpi500")
locvals <- data.frame(extract(covariates, locations))
locvals$site <- locations$CID==1

mod <- glm(site~elevation+tot_inso+aspect+slope+visual_prom+tpi100+wetland_cost+geol_cost+hydro_cost+lcp_cost+wind+tpi500, data=locvals, family=binomial(logit))
summary(mod)
mod2 <- stepAIC(mod)  # More oncs
mod2$anova

# Table with the results of predictive analysis
summary(mod2) 
logodds <- 7.2294176+(elevation* -0.0167014)+(slope*-0.3456405)+(visual_prom*0.0458370)+(wetland_cost*-0.0017355)+(hydro_cost*0.0007585)
par(mfrow=c(1,1))
plot(logodds)

# Predictive map creation
relprob <- (exp(logodds))/(1+(exp(logodds)))
par(mfrow=c(1,1))
plot(relprob, col=terrain.colors(8, alpha=1), legend=TRUE, axes=TRUE, main="GLM Monforte")
points(locations[locations$CID==1,], pch=19, cex=0.3, col="red")

# Output predictive surface .asc 
writeRaster(relprob,filename = "predicsurface2.asc", datatype="ascii", overwrite=TRUE)
```

# Intensity analysis
### Data import

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
elevation <- raster("grids/dem_monforte.tif")
studyarea <- readOGR(dsn="shp/study_area.shp", layer="study_area")
sites <- readOGR(dsn="shp/sites.shp", layer="sites")
area <- as(studyarea,"owin")
sppp <- ppp(x=sites$utmx, y=sites$utmy, window=area)
slope <- raster("grids/slope_monforte.tif")
wetland_cost <- raster("grids/wetland_cost_monforte.tiff")
hydro_cost <- raster("grids/hydrology_cost_monforte.tiff")
visual_prom <- raster("grids/visual_prominence_monforte.tif")
```

### Achieve monovariate patron

```{r echo=TRUE, results='hide'}
elev <- as.im(as(elevation,"SpatialGridDataFrame"))
slo <- as.im(as(slope,"SpatialGridDataFrame"))
wetl <- as.im(as(wetland_cost,"SpatialGridDataFrame"))
hydro <- as.im(as(hydro_cost,"SpatialGridDataFrame"))
vipro <- as.im(as(visual_prom,"SpatialGridDataFrame"))
```

### Intensity function

```{r echo=TRUE, results='hide'}
elev.rh <- rhohat(sppp, elev, confidence=0.95)
slo.rh <- rhohat(sppp, slo, confidence=0.95)
wetl.rh <- rhohat(sppp, wetl, confidence=0.95)
hydro.rh <- rhohat(sppp, hydro, confidence=0.95)
vipro.rh <- rhohat(sppp, vipro, confidence=0.95)
```

### Elevation function

```{r echo=TRUE, results='hide'}
plot(elev.rh, main= "", xlab="m.a.s.l", ylab="", xlim=c(250,500), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Altitude", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1B.pdf",width = 5,height = 12)
```

### Slope function

```{r echo=TRUE, results='hide'}
plot(slo.rh, main= "", xlab="Grades", ylab="", xlim=c(0,6.8), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Slope", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1C.pdf",width = 5,height = 12)
```

### Cost to potential hydrology

```{r echo=TRUE, results='hide'}
plot(hydro.rh, main= "", xlab="Seconds", ylab="", xlim=c(0,6500), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Cost to potential hydrology", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1D.pdf",width = 5,height = 12)
```

### Cost to wetland areas

```{r echo=TRUE, results='hide'}
plot(wetl.rh, main= "", xlab="Seconds", ylab="", xlim=c(0,1150), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Cost to wetland areas", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1E.pdf",width = 5,height = 12)
```

### Visual prominence

```{r echo=TRUE, results='hide'}
plot(vipro.rh, main= "", xlab="Index", ylab="", xlim=c(0,105), legend=FALSE, cex.axis=0.9)
legend("topleft", legend="Visual prominence", cex=0.9, bty="n", text.font=2)
pdf(file = "~output/Figura1F.pdf",width = 5,height = 12)
```

# Barplots (sites vs terrain)

### Import data

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
altplot <- read.table(file="csv/altplot.csv",header=TRUE, sep=";")
altplot1 <- read.table(file="csv/altplot1.csv",header=TRUE, sep=";")
altplot2 <- read.table(file="csv/altplot2.csv",header=TRUE, sep=";")
altplot3 <- read.table(file="csv/altplot3.csv",header=TRUE, sep=";")
altplot4 <- read.table(file="csv/altplot4.csv",header=TRUE, sep=";")
```

### Altitude

```{r echo=TRUE, results='hide'}
altplot$Altitud <- factor (altplot$Altitude, levels = c("0-100", "100-200","200-300","300-400","400-500","500-600","600-700","700-800","800-900","900-1000","1000-1100","1100-1200","1200-1300","1300-1400","1400-1500"))  
p <- ggplot(altplot,aes(Altitude,Percentage)) + geom_bar(data=subset(altplot,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold")) + labs(title = "", y = "Percentage", x = "Altitude (masl)")  
p <- p + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p)
pdf(file = "~output/Figura2A.pdf",width = 5,height = 12)
```

### Slope

```{r echo=TRUE, results='hide'}
altplot1$Slope <- factor (altplot1$Slope, levels = c("0-5", "5-10","10-15","15-20","20-25","25-30","30-35","35-40","40-45","45-50","50-55","55-60","60-65"))  
p1 <- ggplot(altplot1,aes(Slope,Percentage)) + geom_bar(data=subset(altplot1,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot1,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))+ labs(title = "", y = "Percentage", x = "Slope (grades)")   
p1 <- p1 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p1)
pdf(file = "~output/Figura2B.pdf",width = 5,height = 12)
```

### Cost to potential hydrology

```{r echo=TRUE, results='hide'}
altplot2$Cost <- factor (altplot2$Cost, levels = c("0-1000", "1000-2000","2000-3000","3000-4000","4000-5000","5000-6000","6000-7000","7000-8000","8000-9000","9000-10000","10000-11000","11000-12000","12000-13000"))  
p2 <- ggplot(altplot2,aes(Cost,Percentage)) + geom_bar(data=subset(altplot2,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot2,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))+ labs(title = "", y = "Percentage", x = "Cost to potental hydrology (seconds)")   
p2 <- p2 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p2)
pdf(file = "~output/Figura2C.pdf",width = 5,height = 12)
```

### Cost to potential hydrology

```{r echo=TRUE, results='hide'}
altplot3$Cost <- factor (altplot3$Cost, levels = c("0-1000", "1000-2000","2000-3000","3000-4000","4000-5000","5000-6000","6000-7000","7000-8000","8000-9000","9000-10000","10000-11000","11000-12000"))  
p3 <- ggplot(altplot3,aes(Cost,Percentage)) + geom_bar(data=subset(altplot3,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot3,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))+ labs(title = "", y = "Percentage", x = "Cost to wetland areas (seconds)") 
p3 <- p3 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p3)
pdf(file = "~output/Figura2D.pdf",width = 5,height = 12)
```

### Visual prominence

```{r echo=TRUE, results='hide'}
altplot4$Index <- factor (altplot4$Index, levels = c("0-20", "20-40","40-60","60-80","80-100","100-120","120-140","140-160","160-180","180-200"))  
p4 <- ggplot(altplot4,aes(Index,Percentage)) + geom_bar(data=subset(altplot4,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot4,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))+ labs(title = "", y = "Percentage", x = "Prominence visual index")  
p4 <- p4 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
plot(p4)
pdf(file = "~output/Figura2E.pdf",width = 5,height = 12)
```

