---
title: "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin, NW Iberian Peninsula"
author: "Mikel Diaz-Rodriguez, Ramon Fabregas-Valcarce and Augusto Perez-Alberti"
date: "February 14th, 2023"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE,
                      echo = TRUE)
```

# Introduction

This document contains code to enable reproducibility of the paper "A predictive model for Palaeolithic sites: A case study of Monforte de Lemos basin, NW Iberian Peninsula".

The steps indicated in the following lines allow to reproduce the analyses carried out.

# Packages used
### Import the packages

```{r echo=TRUE, results='hide'}
# ipak function: install and load multiple R packages.

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
# install all the packages
packages <- c("GGally", "readxl", "rgdal", "rgeos", "sp", "spatstat", "tidyverse", "dismo", "MASS", "ggplot2", "plyr", "maps", "maptools", "raster", "geostatsp", "patchwork", "vioplot")
ipak(packages)
```

# Violin plot (Figure 2)

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}

# Set the working directory
setwd("~/csv")

# import data
artefacts <- read.table(file="artefacts.csv",header=TRUE, sep=";", stringsAsFactors=F, dec=".")
artefacts_n <- read.table(file="artefacts_n.csv",header=TRUE, sep=";", stringsAsFactors=F, dec=".")

# Create Figure 2a 

vioplot(artefacts$Artefacts,
         col = 8,               
         rectCol = "black",       
         lineCol = "white",     
         colMed = "blue",     
         border = "black",      
         pchMed = 16,           
         plotCentre = "points", 
         ylab = "Number of artefacts",
	   xlab = "Number of sites",  
         main = "a. Violin plot with all artefats per sites") 

stripchart(artefacts$Artefacts, method = "jitter", col = "#cf645e",
            vertical = TRUE, pch = 19, add = TRUE)

# Create Figure 2b

vioplot(artefacts_n$Artefacts,
         col = 8,               
         rectCol = "black",       
         lineCol = "white",     
         colMed = "blue",     
         border = "black",      
         pchMed = 16,           
         plotCentre = "points", 
         ylab = "Number of artefacts",
	   xlab = "Number of sites",  
         main = "b. Violin plot without 1 overrepresented site") 

stripchart(artefacts_n$Artefacts, method = "jitter", col = "#cf645e",
            vertical = TRUE, pch = 19, add = TRUE)

```

# Complete Spatial Randomness
### Import the data used in CSR analysis

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory             
setwd("~/shp")

# set the projection 
BNG = "+init=epsg:25829"

# add the study area 
studyarea <- readShapePoly("Study_area.shp", proj4string = CRS(BNG))
studyarea <- readOGR(dsn="study_area.shp", layer="study_area")

# and check it is worked
plot(studyarea)

# add the sites
sites <- readShapePoints("sites.shp", proj4string = CRS(BNG))
sites <- readOGR(dsn="sites.shp", layer="sites")

# add the random points
random_sites <- readShapePoints("random_sites.shp", proj4string = CRS(BNG))
random_sites <- readOGR(dsn="random_sites.shp", layer="random_sites")

# plot the studyarea and the sites and check everything looks ok
plot(sites, col="blue", pch=20, add=T)

# remove any sites with the same grid reference
sites <- remove.duplicates(sites)

# select the points inside the studyarea 
sitesSub <- sites[studyarea,]

# check to see that they have been removed
plot(studyarea)
plot(sitesSub, col="red", pch=20, add=T)

# set a window as the studyarea
window <- as.owin(studyarea)
plot(window)

# create a ppp object
sitesSub.ppp <- ppp(x=sitesSub$UTMX,y=sitesSub$UTMY,window=window)

# plot the sites and the studyarea
plot(sitesSub.ppp,pch=16,cex=0.5, main="Palaeolithic archaeological sites")
```

### Shapiro-Wilk Test (sites)

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# Shapiro-Wilk Test
shapiro.test(sites$UTMX)
```

### Shapiro-Wilk Test (random sites)

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# Shapiro-Wilk Test
shapiro.test(random_sites$UTMX)
```

### K-S Test

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# K-S sites vs random sites
ks.test(sites$UTMX,random_sites$UTMX)
```

### K, L and G Functions

```{r echo=TRUE, results='hide'}
# set the simulations
sims <- 99
# to get 95% envelope
nrank <- round((sims + 1) / 100 * 2.5, 0) 

# K, L and G functions 
Kfunction <- envelope(sitesSub.ppp,Kest, nsim=sims,rank=nrank, correction="best") 
KinhomFunction <- envelope(sitesSub.ppp,Kinhom, nsim=sims,rank=nrank, correction="best")
LFunction <- envelope(sitesSub.ppp,Lest, nsim=sims,rank=nrank, correction="best")
LinhomFunction <- envelope(sitesSub.ppp,Linhom, nsim=sims,rank=nrank, correction="best")
GFunction <- envelope(sitesSub.ppp,Gest, nsim=sims,rank=nrank, correction="best")
GinhomFunction <- envelope(sitesSub.ppp,Ginhom, nsim=sims,rank=nrank, correction="best")

# create Figure 4
par(mar=c(4, 4, 4, 4), mfrow=c(3,2))
plot(Kfunction,main="a. K Function (homogeneous)",legend=FALSE)
plot(KinhomFunction,main="b. K Function (inhomogeneous)",legend=FALSE)
plot(LFunction,main="c. L Function (homogeneous)",legend=FALSE)
plot(LinhomFunction,main="d. L Function (inhomogeneous)",legend=FALSE) 
plot(GFunction,main="e. G Function (homogeneous)",legend=FALSE) 
plot(GinhomFunction,main="f. G Function (inhomogeneous)",legend=FALSE)
par(mfrow=c(1,1))
png(file = "~/output/Figure4.png",width = 900,height = 1200)
dev.off()
```

# Pearson's Correlation

```{r echo=TRUE, results='hide'}
# Set the working directory
setwd("~/csv")

# import data
dat <- read.table(file="dat.csv",header=TRUE, sep=";", stringsAsFactors=F, dec=".")

# Data
sample_data <- data.frame(v1=dat$altitude,v2=dat$wetland_cost,v3=dat$goat_cost,v5=dat$geology_cost,v6=dat$hydrology_cost,v7=dat$lcp_cost,v8=dat$eucl_dist_geo,v9=dat$eucl_dist_hydro,v10=dat$dif_ins,v11=dat$dir_ins,v12=dat$tot_ins,v13=dat$aspect,v14=dat$slope,v15=dat$vis_prom,v16=dat$tpi100,v17=dat$tpi500,v18=dat$tpi1000,v19=dat$wind)

# Check correlations
cor(sample_data)

# Check correlations as scatterplots, distributions and correlation coefficient.
ggpairs(sample_data)

# Visualization
ggcorr(sample_data, method=c("everything", "pearson"))

# Export file
png(file = "~/output/Figure5.png",width = 900,height = 1200)
```

# GLM

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# set the working directory
setwd("~/shp")

# ad the shapefile
locations <- readOGR(dsn="locations.shp", layer="locations")

# set the working directory
setwd("~/grids")

# Import variables and set the same extent for everyone
elevation <- raster("dem_monforte.tif")
tot_ins <- raster("total_insolation_monforte.asc")
tot_inso <- projectRaster(tot_ins, elevation)
asp <- raster("aspect_monforte.tif")
aspect <- projectRaster(asp, elevation)
slop <- raster("slope_monforte.tif")
slope <- projectRaster(slop, elevation)
vis_prom <- raster("visual_prominence_monforte.tif")
visual_prom <- projectRaster(vis_prom, elevation)
tpi100_monf <- raster("tpi100_monforte.asc")
tpi100 <- projectRaster(tpi100_monf, elevation)
wind_monf <- raster("wind_monforte.asc")
wind <- projectRaster(wind_monf, elevation)
wetland_c <- raster("wetland_cost_monforte.tiff")
wetland_cost <- projectRaster(wetland_c, elevation)
goat_c <- raster("goat_cost_monforte.tiff")
goat_cost <- projectRaster(goat_c, elevation)
geol_c <- raster("geology_cost_monforte.tiff")
geol_cost <- projectRaster(geol_c, elevation)
hydro_c <- raster("hydrology_cost_monforte.tiff")
hydro_cost <- projectRaster(hydro_c, elevation)
lcp_c <- raster("lcp_cost_monforte.tiff")
lcp_cost <- projectRaster(lcp_c, elevation)
```

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
# GLM creation
covariates <- stack(elevation, tot_inso, aspect, slope, visual_prom, tpi100, wetland_cost, geol_cost, hydro_cost, lcp_cost, wind)
names(covariates) <- c("elevation", "tot_inso", "aspect", "slope", "visual_prom", "tpi100", "wetland_cost", "geol_cost","hydro_cost", "lcp_cost", "wind")
locvals <- data.frame(extract(covariates, locations))
locvals$site <- locations$CID==1

mod <- glm(site~elevation+tot_inso+aspect+slope+visual_prom+tpi100+wetland_cost+geol_cost+hydro_cost+lcp_cost+wind, data=locvals, family=binomial(logit))
summary(mod)
mod2 <- stepAIC(mod)  # More oncs
mod2$anova

# Table with the results of predictive analysis
summary(mod2) 
logodds <- 7.2294176+(elevation* -0.0167014)+(slope*-0.3456405)+(visual_prom*0.0458370)+(wetland_cost*-0.0017355)+(hydro_cost*0.0007585)
par(mfrow=c(1,1))
plot(logodds)

# Predictive map creation
relprob <- (exp(logodds))/(1+(exp(logodds)))
par(mfrow=c(1,1))
plot(relprob, col=terrain.colors(8, alpha=1), legend=TRUE, axes=TRUE, main="GLM Monforte")
points(locations[locations$CID==1,], pch=19, cex=0.3, col="red")

# Output predictive surface .asc 
writeRaster(relprob,filename = "~/output/predicsurface2.asc", datatype="ascii", overwrite=TRUE)
```

# Intensity analysis
### Data import

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
elevation <- raster("~/grids/dem_monforte.tif")
studyarea <- readOGR(dsn="~shp/study_area.shp", layer="study_area")
sites <- readOGR(dsn="~/shp/sites.shp", layer="sites")
area <- as(studyarea,"owin")
sppp <- ppp(x=sites$UTMX, y=sites$UTMY, window=area)
slope <- raster("~/grids/slope_monforte.tif")
wetland_cost <- raster("~/grids/wetland_cost_monforte.tiff")
hydro_cost <- raster("~/grids/hydrology_cost_monforte.tiff")
visual_prom <- raster("~/grids/visual_prominence_monforte.tif")
```

### Achieve monovariate patron

```{r echo=TRUE, results='hide'}
elev <- as.im(as(elevation,"SpatialGridDataFrame"))
slo <- as.im(as(slope,"SpatialGridDataFrame"))
wetl <- as.im(as(wetland_cost,"SpatialGridDataFrame"))
hydro <- as.im(as(hydro_cost,"SpatialGridDataFrame"))
vipro <- as.im(as(visual_prom,"SpatialGridDataFrame"))
```

### Intensity function

```{r echo=TRUE, results='hide'}
elev.rh <- rhohat(sppp, elev, confidence=0.95)
slo.rh <- rhohat(sppp, slo, confidence=0.95)
wetl.rh <- rhohat(sppp, wetl, confidence=0.95)
hydro.rh <- rhohat(sppp, hydro, confidence=0.95)
vipro.rh <- rhohat(sppp, vipro, confidence=0.95)
```

### Create Figure 7

```{r echo=TRUE, results='hide'}
par(mar=c(4, 4, 4, 4), mfrow=c(3,2))
plot(elev.rh, main="a. Altitude", xlab="m.a.s.l.", ylab="", legend=FALSE, cex.axis=0.9)
plot(slo.rh, main="b. Slope", xlab="Degrees", ylab="", legend=FALSE, cex.axis=0.9)
plot(hydro.rh, main="c. Cost to potential hydrology cells", xlab="Seconds", ylab="", legend=FALSE, cex.axis=0.9)
plot(wetl.rh, main="d. Cost to potential wetland cells", xlab="Seconds", ylab="", legend=FALSE, cex.axis=0.9)
plot(vipro.rh, main="e. Visual Prominence", xlab="Visible cells number", ylab="", legend=FALSE, cex.axis=0.9)
par(mfrow=c(1,1))
png(file = "~/output/Figure7.png",width = 900,height = 1200)
dev.off()
```

# Barplots (sites vs terrain)

### Import data

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}
altplot <- read.table(file="csv/altplot.csv",header=TRUE, sep=";")
altplot1 <- read.table(file="csv/altplot1.csv",header=TRUE, sep=";")
altplot2 <- read.table(file="csv/altplot2.csv",header=TRUE, sep=";")
altplot3 <- read.table(file="csv/altplot3.csv",header=TRUE, sep=";")
altplot4 <- read.table(file="csv/altplot4.csv",header=TRUE, sep=";")
```

### Altitude

```{r echo=TRUE, results='hide'}
altplot$Altitude <- factor (altplot$Altitude, levels = c("0-100", "100-200","200-300","300-400","400-500","500-600","600-700","700-800","800-900","900-1000","1000-1100","1100-1200","1200-1300","1300-1400","1400-1500"))  
p <- ggplot(altplot,aes(Altitude,Percentage)) + geom_bar(data=subset(altplot,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=8,face="bold"),axis.title=element_text(size=10,face="bold")) + labs(title = "a. Altitude", y = "Percentage", x = "m.a.s.l.")  
p <- p + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
```

### Slope

```{r echo=TRUE, results='hide'}
altplot1$Slope <- factor (altplot1$Slope, levels = c("0-5", "5-10","10-15","15-20","20-25","25-30","30-35","35-40","40-45","45-50","50-55","55-60","60-65"))  
p1 <- ggplot(altplot1,aes(Slope,Percentage)) + geom_bar(data=subset(altplot1,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot1,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=8,face="bold"),axis.title=element_text(size=10,face="bold"))+ labs(title = "b. Slope", y = "Percentage", x = "Grades")   
p1 <- p1 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
```

### Cost to potential hydrology

```{r echo=TRUE, results='hide'}
altplot2$Cost <- factor (altplot2$Cost, levels = c("0-1000", "1000-2000","2000-3000","3000-4000","4000-5000","5000-6000","6000-7000","7000-8000","8000-9000","9000-10000","10000-11000","11000-12000","12000-13000"))  
p2 <- ggplot(altplot2,aes(Cost,Percentage)) + geom_bar(data=subset(altplot2,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot2,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=8,face="bold"),axis.title=element_text(size=10,face="bold"))+ labs(title = "c. Cost to potential hydrology", y = "Percentage", x = "Seconds")   
p2 <- p2 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
```

### Cost to potential wetland areas

```{r echo=TRUE, results='hide'}
altplot3$Cost <- factor (altplot3$Cost, levels = c("0-1000", "1000-2000","2000-3000","3000-4000","4000-5000","5000-6000","6000-7000","7000-8000","8000-9000","9000-10000","10000-11000","11000-12000"))  
p3 <- ggplot(altplot3,aes(Cost,Percentage)) + geom_bar(data=subset(altplot3,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot3,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=8,face="bold"),axis.title=element_text(size=10,face="bold"))+ labs(title = "d. Cost to wetland cells", y = "Percentage", x = "Seconds") 
p3 <- p3 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
```

### Visual prominence

```{r echo=TRUE, results='hide'}
altplot4$Index <- factor (altplot4$Index, levels = c("0-20", "20-40","40-60","60-80","80-100","100-120","120-140","140-160","160-180","180-200"))  
p4 <- ggplot(altplot4,aes(Index,Percentage)) + geom_bar(data=subset(altplot4,Category=="Terrain"),stat="identity", fill="gray") + geom_line(data=subset(altplot4,Category=="Site"), aes(group="Category", colour="red"),size=1.5) + guides(colour=FALSE) + theme(axis.text=element_text(size=8,face="bold"),axis.title=element_text(size=10,face="bold"))+ labs(title = "e. Visual Prominence", y = "Percentage", x = "Visible cells number")  
p4 <- p4 + theme( 
  panel.background = element_rect(fill = "transparent",colour = NA), 
  panel.grid.minor = element_blank(), 
  panel.grid.major = element_blank(), 
  plot.background = element_rect(fill = "transparent",colour = NA) 
)
```


### create Figure 8

```{r echo=TRUE, results='hide'}
p / p1 / p2 / p3 / p4

png(file = "~/output/Figure8.png",width = 1000,height = 1200)
```
